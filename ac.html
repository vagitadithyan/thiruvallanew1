<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AC View</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: #ffffff;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 15px 20px;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .breadcrumb a {
            color: white;
            text-decoration: none;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        
        .breadcrumb a:hover {
            opacity: 1;
        }
        
        .breadcrumb span {
            opacity: 0.6;
        }
        
        .header h1 {
            font-size: 1.5em;
            font-weight: 600;
        }
        
        .container {
            display: flex;
            height: calc(100vh - 70px);
        }
        
        .sidebar {
            width: 300px;
            background: #f8f9fa;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #e0e0e0;
        }
        
        .sidebar h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: 600;
        }
        
        .mandal-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .mandal-item {
            padding: 12px;
            background: white;
            border-left: 4px solid #27ae60;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .mandal-item:hover {
            transform: translateX(3px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .mandal-name {
            font-weight: 500;
            color: #2c3e50;
            font-size: 0.95em;
        }
        
        .mandal-stats {
            font-size: 0.8em;
            color: #7f8c8d;
            margin-top: 4px;
        }
        
        .map-container {
            flex: 1;
            position: relative;
            background: #f0f0f0;
        }
        
        #map {
            width: 100%;
            height: 100%;
            background: #f0f0f0;
        }
        
        .leaflet-control-attribution {
            display: none !important;
        }
        
        .leaflet-container {
            background: #f0f0f0 !important;
        }
        
        .info-box {
            position: absolute;
            top: 15px;
            right: 15px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 220px;
        }
        
        .info-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 1em;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 8px;
        }
        
        .info-item {
            margin: 8px 0;
            font-size: 0.9em;
        }
        
        .info-label {
            color: #7f8c8d;
            font-size: 0.85em;
        }
        
        .info-value {
            color: #2c3e50;
            font-weight: 500;
            font-size: 1.1em;
        }

        /* Preview Modal Styles */
        .nav-actions {
            margin-top: 15px;
            padding: 10px 0;
        }
        
        .action-btn {
            width: 100%;
            padding: 12px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }
        
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        .preview-modal.active {
            display: flex;
        }
        
        .preview-content {
            background: white;
            width: 90%;
            height: 90%;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .preview-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .preview-header h2 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .preview-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: stretch;
            justify-content: center;
        }
        
        .preview-controls select,
        .preview-controls button {
            min-width: 170px;
            height: 44px;
            border: 2px solid white;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            outline: none;
        }
        
        .preview-controls select {
            padding: 0 15px;
        }
        
        .preview-controls select option {
            background: #667eea;
            color: white;
        }
        
        .preview-controls button {
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .preview-controls button:hover {
            background: white;
            color: #667eea;
        }
        
        .preview-close {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .preview-close:hover {
            background: white;
            color: #667eea;
            transform: rotate(90deg);
        }
        
        .preview-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .preview-map {
            flex: 1;
            min-height: 400px;
            background: #ffffff !important;
        }
        
        #previewMap {
            background: #ffffff !important;
        }
        
        #previewMap .leaflet-container {
            background: #ffffff !important;
        }
        
        .preview-info {
            flex: 1;
            background: #ffffff;
            padding: 30px;
            overflow-y: auto;
        }
        
        .preview-info h3 {
            color: #2c3e50;
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            max-width: 100%;
        }
        
        .data-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .data-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .data-item strong {
            display: block;
            color: #495057;
            font-size: 12px;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-item span {
            color: #2c3e50;
            font-size: 16px;
            font-weight: 500;
        }
        
        .color-box {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            display: inline-block;
            margin-right: 10px;
            border: 2px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="breadcrumb">
            <a href="kerala_map.html">Kerala</a>
            <span>/</span>
            <a href="#" id="districtLink">District</a>
            <span>/</span>
            <span id="acBreadcrumb">AC</span>
        </div>
        <h1 id="acTitle">Loading...</h1>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <h2>Mandals</h2>
            <div class="mandal-list" id="mandalList"></div>
            <div class="nav-actions">
                <button class="action-btn" onclick="showPreview()">
                    üëÅÔ∏è Preview & Download
                </button>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            <div class="info-box">
                <div class="info-title">AC Info</div>
                <div class="info-item">
                    <div class="info-label">Mandals</div>
                    <div class="info-value" id="totalMandals">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Local Bodies</div>
                    <div class="info-value" id="totalLBs">-</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, currentAC, currentDistrict;
        let corporationMandalsCache = null;
        
        const urlParams = new URLSearchParams(window.location.search);
        const districtId = urlParams.get('district');
        const acId = urlParams.get('ac');
        
        if (!districtId || !acId) {
            alert('Invalid parameters!');
            window.location.href = 'kerala_map.html';
        }
        
        // Match Kerala state map colors
        const districtColors = {
            'thiruvananthapuram': '#9C27B0', 'kollam': '#FF9800', 'pathanamthitta': '#E91E63',
            'alappuzha': '#FF5722', 'kottayam': '#00BCD4', 'idukki': '#8BC34A',
            'ernakulam': '#2196F3', 'thrissur': '#FFC107', 'palakkad': '#FF9800',
            'malappuram': '#4CAF50', 'kozhikode': '#009688', 'wayanad': '#795548',
            'kannur': '#3F51B5', 'kasaragod': '#CDDC39'
        };
        
        // Vibrant color palette for all polygons
        const vibrantColors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
            '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B195', '#F67280',
            '#C06C84', '#6C5B7B', '#355C7D', '#99B898', '#FECEAB',
            '#FF847C', '#E84A5F', '#2A363B', '#A8E6CF', '#FFD3B6',
            '#FFAAA5', '#FF8B94', '#FEC3A6', '#EFE9AE', '#CDEAC0',
            '#8E44AD', '#3498DB', '#1ABC9C', '#F39C12', '#E74C3C',
            '#9B59B6', '#2ECC71', '#E67E22', '#95A5A6', '#34495E'
        ];
        
        function getVibrantColors(count) {
            const colors = [];
            for (let i = 0; i < count; i++) {
                colors.push(vibrantColors[i % vibrantColors.length]);
            }
            return colors;
        }
        
        map = L.map('map', {
            zoomControl: true,
            attributionControl: false,
            preferCanvas: true
        }).setView([10.8505, 76.2711], 9);
        
        function cleanId(name) {
            return name.toLowerCase().replace(/[^a-z0-9]/g, '');
        }
        
        function toMultiPolygon(geometries) {
            if (!geometries || !geometries.length) return null;
            const coordinates = geometries.map(geom => {
                if (!geom) return null;
                if (geom.type === 'Polygon') return [geom.coordinates];
                if (geom.type === 'MultiPolygon') return geom.coordinates;
                return null;
            }).filter(Boolean).flat();
            if (!coordinates.length) return null;
            return { type: 'MultiPolygon', coordinates };
        }

        function flattenGeometryFragments(geometry) {
            if (!geometry) return [];
            if (geometry.type === 'FeatureCollection' && Array.isArray(geometry.features)) {
                return geometry.features.flatMap(feature => flattenGeometryFragments(feature));
            }
            if (geometry.type === 'Feature' && geometry.geometry) {
                return flattenGeometryFragments(geometry.geometry);
            }
            if (geometry.type === 'Polygon' || geometry.type === 'MultiPolygon') {
                return [geometry];
            }
            return [];
        }

        function ensureMandalLocalBodies(mandal) {
            if (!mandal) return [];
            if (Array.isArray(mandal.local_bodies)) return mandal.local_bodies;
            if (Array.isArray(mandal.localBodies)) {
                mandal.local_bodies = mandal.localBodies;
                return mandal.local_bodies;
            }
            mandal.local_bodies = [];
            return mandal.local_bodies;
        }

        function getLocalBodyGeometry(lb) {
            if (!lb) return null;
            if (lb.geometry) return lb.geometry;
            if (lb.wards && lb.wards.length) {
                const wardGeoms = lb.wards.map(ward => ward.geometry).filter(Boolean);
                return toMultiPolygon(wardGeoms);
            }
            return null;
        }

        function buildMandalGeometry(mandal) {
            if (mandal?.geometry) return mandal.geometry;
            const fragments = [];
            ensureMandalLocalBodies(mandal).forEach(lb => {
                const geometry = lb.geometry || getLocalBodyGeometry(lb);
                flattenGeometryFragments(geometry).forEach(fragment => fragments.push(fragment));
            });
            if (!fragments.length) return null;
            const aggregated = toMultiPolygon(fragments);
            if (aggregated) mandal.geometry = aggregated;
            return mandal.geometry;
        }

        async function init() {
            try {
                // Load consolidated 14-district data
                const response = await fetch(`data/14_districts/${districtId}.json`);
                if (!response.ok) {
                    alert('District data not found!');
                    return;
                }
                
                currentDistrict = await response.json();
                
                // Find AC by matching cleaned name
                currentAC = currentDistrict.acs.find(ac => cleanId(ac.name) === acId);
                
                if (!currentAC) {
                    alert('AC not found!');
                    console.log('Looking for AC ID:', acId);
                    console.log('Available ACs:', currentDistrict.acs.map(ac => ({name: ac.name, id: cleanId(ac.name)})));
                    return;
                }

                await enhanceCorporationMandals();
                await ensureKovalamCorporationSlice();
                
                // Update header
                document.getElementById('acTitle').textContent = currentAC.name;
                document.getElementById('acBreadcrumb').textContent = currentAC.name;
                document.getElementById('districtLink').href = `district.html?district=${districtId}`;
                document.title = `${currentAC.name} - AC View`;
                
                // Update info
                let totalLBs = 0;
                currentAC.mandals.forEach(mandal => {
                    totalLBs += ensureMandalLocalBodies(mandal).length;
                });
                
                document.getElementById('totalMandals').textContent = currentAC.mandals.length;
                document.getElementById('totalLBs').textContent = totalLBs;
                
                // Render mandal list
                renderMandalList(currentAC.mandals);
                
                // Load mandal boundaries
                await loadMandalBoundaries();
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading AC data.');
            }
        }

        async function loadCorporationMandalsData() {
            if (corporationMandalsCache !== null) {
                return corporationMandalsCache;
            }
            try {
                const response = await fetch('data/corporation_mandals.json');
                if (!response.ok) {
                    console.warn('Corporation mandals file missing');
                    corporationMandalsCache = { features: [] };
                    return corporationMandalsCache;
                }
                corporationMandalsCache = await response.json();
            } catch (error) {
                console.warn('Failed to load corporation mandals file', error);
                corporationMandalsCache = { features: [] };
            }
            return corporationMandalsCache;
        }

        async function enhanceCorporationMandals() {
            try {
                const corpData = await loadCorporationMandalsData();
                const relevant = (corpData.features || []).filter(feature => {
                    return feature?.properties?.ac_id === acId;
                });
                
                if (!relevant.length) {
                    return;
                }
                
                relevant.forEach(feature => {
                    const props = feature.properties || {};
                    const mandalKey = cleanId(props.mandal_id || props.mandal_name || props.corporation_name || '');
                    if (!mandalKey) return;
                    
                    const geometryFeature = {
                        type: 'Feature',
                        properties: {
                            source: 'corporation_mandals',
                            corporation: props.corporation_name,
                            mandal: props.mandal_name
                        },
                        geometry: feature.geometry
                    };
                    const wardFeatures = (props.ward_features || []).map(ward => ({
                        type: 'Feature',
                        properties: {
                            ward_number: ward?.properties?.ward_number || ward?.ward_number,
                            ward_name: ward?.properties?.ward_name || ward?.ward_name
                        },
                        geometry: ward.geometry
                    }));
                    
                    let mandal = currentAC.mandals.find(m => cleanId(m.name) === mandalKey);
                    if (mandal) {
                        mandal.geometry = geometryFeature;
                        mandal.isCorporationMandal = true;
                        mandal.corporationMeta = props;
                        mandal.corporationWardFeatures = wardFeatures;
                    } else {
                        mandal = {
                            name: props.mandal_name || props.corporation_name || 'Corporation Mandal',
                            local_bodies: [],
                            geometry: geometryFeature,
                            isCorporationMandal: true,
                            corporationMeta: props,
                            corporationWardFeatures: wardFeatures
                        };
                        currentAC.mandals.push(mandal);
                    }
                    
                    // Inject synthetic local body so mandal/localbody pages can drill down
                    const corpLbId = `corp_${props.mandal_id || cleanId(props.mandal_name || props.corporation_name || '')}`;
                    if (!mandal.local_bodies.some(lb => lb.id === corpLbId)) {
                        mandal.local_bodies.push({
                            id: corpLbId,
                            name: props.mandal_name || props.corporation_name,
                            type: 'Corporation Mandal',
                            code: props.corporation_id || '',
                            wards: wardFeatures.map(ward => ({
                                ward_number: ward.properties?.ward_number,
                                ward_name: ward.properties?.ward_name,
                                geometry: ward.geometry
                            })),
                            geometry: {
                                type: 'FeatureCollection',
                                features: wardFeatures
                            }
                        });
                    }
                });
            } catch (error) {
                console.warn('Unable to enhance corporation mandals', error);
            }
        }

        async function ensureKovalamCorporationSlice() {
            if (!(districtId === 'thiruvananthapuram_south' && acId === 'kovalam')) {
                return;
            }
            
            const mandal = currentAC.mandals.find(m => cleanId(m.name) === 'kovalam');
            if (!mandal) return;
            
            const alreadyExists = mandal.local_bodies.some(lb => cleanId(lb.name) === 'tvm_corporation_kovalam');
            if (alreadyExists) return;
            
            try {
                const response = await fetch('data/thiruvananthapuram_south/kovalam/kovalam/tvm_corporation_kovalam.geojson');
                if (!response.ok) {
                    console.warn('TVM Corporation (Kovalam) data missing');
                    return;
                }
                const geojson = await response.json();
                const wards = (geojson.features || []).map((feature, index) => ({
                    ward_number: feature?.properties?.ward_number || feature?.properties?.Ward_No || `${index + 1}`,
                    ward_name: feature?.properties?.ward_name || feature?.properties?.Ward_Name || `Ward ${index + 1}`,
                    geometry: feature.geometry
                }));
                
                const lbGeometry = {
                    type: 'FeatureCollection',
                    features: (geojson.features || []).map(feature => ({
                        type: 'Feature',
                        properties: {
                            ward_number: feature?.properties?.ward_number || feature?.properties?.Ward_No || '',
                            ward_name: feature?.properties?.ward_name || feature?.properties?.Ward_Name || ''
                        },
                        geometry: feature.geometry
                    }))
                };
                
                mandal.local_bodies.push({
                    name: 'TVM Corporation (Kovalam)',
                    id: 'tvm_corporation_kovalam',
                    code: 'C01001',
                    type: 'C',
                    wards,
                    geometry: lbGeometry
                });
            } catch (error) {
                console.warn('Failed to inject TVM Corporation (Kovalam)', error);
            }
        }
        
        function renderMandalList(mandals) {
            const list = document.getElementById('mandalList');
            list.innerHTML = '';
            
            mandals.forEach(mandal => {
                const mandalLBs = ensureMandalLocalBodies(mandal);
                const item = document.createElement('div');
                item.className = 'mandal-item';
                
                item.innerHTML = `
                    <div class="mandal-name">${mandal.name}</div>
                    <div class="mandal-stats">${mandalLBs.length} Local Bodies</div>
                `;
                
                item.addEventListener('click', function() {
                    window.location.href = `mandal.html?district=${districtId}&ac=${acId}&mandal=${cleanId(mandal.name)}`;
                });
                
                list.appendChild(item);
            });
        }
        
        async function loadMandalBoundaries() {
            try {
                // Use vibrant colors for each mandal
                const mandalColors = getVibrantColors(currentAC.mandals.length);
                
                let allBounds = [];
                
                currentAC.mandals.forEach((mandal, index) => {
                    const mandalGeometry = buildMandalGeometry(mandal);
                    if (!mandalGeometry) return;
                    const mandalLocalBodies = ensureMandalLocalBodies(mandal);
                    
                    const color = mandalColors[index % mandalColors.length];
                    const layer = L.geoJSON(mandalGeometry, {
                        style: {
                            fillColor: color,
                            fillOpacity: 0.5,
                            color: '#2c3e50',
                            weight: 2,
                            opacity: 1
                        },
                        onEachFeature: function(feature, layer) {
                            layer.bindPopup(`
                                <div style="text-align:center; padding:10px;">
                                    <div style="font-size:1.1em; font-weight:600; color:#2c3e50; margin-bottom:5px;">${mandal.name}</div>
                                        <div>${mandalLocalBodies.length} Local Bodies</div>
                                </div>
                            `);
                            
                            layer.on('mouseover', function(e) {
                                layer.setStyle({
                                    weight: 3,
                                    fillOpacity: 0.7
                                });
                            });
                            
                            layer.on('mouseout', function(e) {
                                layer.setStyle({
                                    weight: 2,
                                    fillOpacity: 0.5
                                });
                            });
                            
                            layer.on('click', function(e) {
                                window.location.href = `mandal.html?district=${districtId}&ac=${acId}&mandal=${cleanId(mandal.name)}`;
                            });
                        }
                    }).addTo(map);
                    
                    allBounds.push(layer.getBounds());
                    
                    // Add mandal name label
                    const center = layer.getBounds().getCenter();
                    L.marker(center, {
                        icon: L.divIcon({
                            className: 'mandal-label',
                            html: `<div style="font-size:11px; font-weight:600; color:#2c3e50; text-align:center; text-shadow: 1px 1px 2px white, -1px -1px 2px white; pointer-events:none; white-space:nowrap;">${mandal.name}</div>`,
                            iconSize: [100, 20]
                        }),
                        interactive: false
                    }).addTo(map);
                });
                
                // Fit map to show all mandals
                if (allBounds.length > 0) {
                    const group = L.featureGroup(allBounds.map(b => L.rectangle(b)));
                    map.fitBounds(group.getBounds(), { padding: [50, 50] });
                }
                
            } catch (error) {
                console.error('Error loading mandal boundaries:', error);
            }
        }

        // Preview & Download functionality
        let previewMap;
        let allLocalBodiesData = [];
        let allWardsData = [];

        function showPreview() {
            const modal = document.getElementById('previewModal');
            modal.classList.add('active');
            
            setTimeout(() => {
                if (previewMap) {
                    previewMap.remove();
                    previewMap = null;
                }
                
                const mapContainer = document.getElementById('previewMap');
                previewMap = L.map(mapContainer, {
                    zoomControl: true,
                    attributionControl: false,
                    preferCanvas: true
                }).setView([10.8505, 76.2711], 10);
                previewMap._previewLayerGroup = L.layerGroup().addTo(previewMap);
                
                // Wait for map container to be fully sized
                setTimeout(() => {
                    previewMap.invalidateSize();
                    updatePreviewBoundary();
                }, 100);
            }, 150);
        }

        function closePreview() {
            document.getElementById('previewModal').classList.remove('active');
            if (previewMap) {
                previewMap.remove();
                previewMap = null;
            }
        }

        function updatePreviewBoundary() {
            const level = document.getElementById('boundaryLevel').value;
            
            if (previewMap && previewMap._previewLayerGroup) {
                previewMap._previewLayerGroup.clearLayers();
            }

            if (level === 'ac') {
                renderPreviewAC();
            } else if (level === 'mandal') {
                renderPreviewMandals();
            } else if (level === 'localbody') {
                renderPreviewLocalBodies();
            } else if (level === 'ward') {
                renderPreviewWards();
            }
        }

        function renderPreviewAC() {
            const dataGrid = document.getElementById('previewDataGrid');
            dataGrid.innerHTML = `
                <div class="data-item">
                    <strong>Assembly Constituency</strong>
                    <span>${currentAC.name}</span>
                </div>
                <div class="data-item">
                    <strong>Total Mandals</strong>
                    <span>${currentAC.mandals.length}</span>
                </div>
            `;

            if (!previewMap) return;
            const layerTarget = previewMap._previewLayerGroup || previewMap;
            const acColor = districtColors[districtId] || '#45B7D1';
            const bounds = [];

            const drawGeometry = (geometry) => {
                const layer = L.geoJSON(geometry, {
                    style: {
                        fillColor: acColor,
                        fillOpacity: 0.85,
                        color: '#ffffff',
                        weight: 3,
                        opacity: 1
                    }
                }).addTo(layerTarget);
                bounds.push(layer.getBounds());
            };

            if (currentAC.geometry) {
                drawGeometry(currentAC.geometry);
            } else if (currentAC.mandals && currentAC.mandals.length > 0) {
                currentAC.mandals.forEach(mandal => {
                    const mandalGeometry = buildMandalGeometry(mandal);
                    if (mandalGeometry) {
                        drawGeometry(mandalGeometry);
                    }
                });
            }

            if (bounds.length > 0) {
                const group = L.featureGroup(bounds.map(b => L.rectangle(b)));
                previewMap.fitBounds(group.getBounds(), { padding: [20, 20] });
            }
        }

        function renderPreviewMandals() {
            const dataGrid = document.getElementById('previewDataGrid');
            dataGrid.innerHTML = '';
            
            console.log("=== Starting Mandal Rendering ===");
            console.log("Preview map exists:", !!previewMap);
            console.log("Current AC:", currentAC?.name);
            
            if (!currentAC || !currentAC.mandals) {
                console.log("No mandal data available");
                dataGrid.innerHTML = '<div class="data-item"><span>No mandal data available</span></div>';
                return;
            }

            console.log("Total mandals:", currentAC.mandals.length);

            const mandalColors = getVibrantColors(currentAC.mandals.length);
            
            currentAC.mandals.forEach((mandal, index) => {
                const mandalLocalBodies = ensureMandalLocalBodies(mandal);
                const color = mandalColors[index % mandalColors.length];
                mandal.previewColor = color;
                console.log(`Mandal ${index + 1}:`, mandal.name, "| Has geometry:", !!mandal.geometry, "| Color:", color);
                
                const div = document.createElement('div');
                div.className = 'data-item';
                div.innerHTML = `
                    <span class="color-box" style="background-color: ${color}"></span>
                    <strong>${mandal.name}</strong>
                    <span>${mandalLocalBodies.length} Local Bodies</span>
                `;
                dataGrid.appendChild(div);
            });

            // Render mandals on map with enhanced styling - WITH GEOMETRY AGGREGATION
            if (previewMap && currentAC.mandals.length > 0) {
                let allBounds = [];
                currentAC.mandals.forEach((mandal, index) => {
                    const color = mandalColors[index % mandalColors.length];
                    
                    // Aggregate geometry from mandal, LBs, or wards
                    let geometryToRender = null;
                    
                    geometryToRender = buildMandalGeometry(mandal);
                    
                    if (geometryToRender) {
                        console.log(`Rendering mandal "${mandal.name}" with color ${color}`);
                        const layer = L.geoJSON(geometryToRender, {
                            style: {
                                fillColor: color,
                                fillOpacity: 0.85,
                                color: '#ffffff',
                                weight: 3,
                                opacity: 1
                            }
                        }).addTo(previewMap._previewLayerGroup || previewMap);
                        allBounds.push(layer.getBounds());
                        console.log(`‚úì Successfully rendered mandal "${mandal.name}"`);
                    } else {
                        console.warn(`‚úó Mandal "${mandal.name}" has no geometry at any level`);
                    }
                });
                if (allBounds.length > 0) {
                    const group = L.featureGroup(allBounds.map(b => L.rectangle(b)));
                    previewMap.fitBounds(group.getBounds(), { padding: [20, 20] });
                    console.log("Map bounds updated to fit all mandals");
                }
            }
        }

        function renderPreviewLocalBodies() {
            const dataGrid = document.getElementById('previewDataGrid');
            dataGrid.innerHTML = '';
            
            console.log("=== Starting Local Body Rendering ===");
            console.log("Preview map exists:", !!previewMap);
            
            if (!currentAC || !currentAC.mandals) {
                console.log("No local body data available");
                dataGrid.innerHTML = '<div class="data-item"><span>No data available</span></div>';
                return;
            }

            let totalLBs = 0;
            currentAC.mandals.forEach(mandal => totalLBs += ensureMandalLocalBodies(mandal).length);
            const lbColors = getVibrantColors(totalLBs);
            let lbIndex = 0;
            allLocalBodiesData = [];
            
            currentAC.mandals.forEach(mandal => {
                const mandalLocalBodies = ensureMandalLocalBodies(mandal);
                console.log(`Processing mandal: ${mandal.name} with ${mandalLocalBodies.length} local bodies`);
                mandalLocalBodies.forEach(lb => {
                    const color = lbColors[lbIndex % lbColors.length];
                    lb.previewColor = color;
                    console.log(`Local Body ${lbIndex + 1}: ${lb.name} | Has geometry: ${!!lb.geometry} | Color: ${color}`);
                    lbIndex++;
                    
                    const div = document.createElement('div');
                    div.className = 'data-item';
                    div.innerHTML = `
                        <span class="color-box" style="background-color: ${color}"></span>
                        <strong>${lb.name}</strong>
                        <span>${mandal.name}</span>
                    `;
                    dataGrid.appendChild(div);
                    allLocalBodiesData.push({
                        name: lb.name,
                        mandal: mandal.name,
                        color
                    });
                });
            });

            // Render local bodies on map with enhanced styling
            if (previewMap && currentAC.mandals.length > 0) {
                let allBounds = [];
                lbIndex = 0;
                currentAC.mandals.forEach(mandal => {
                    const mandalLocalBodies = ensureMandalLocalBodies(mandal);
                    mandalLocalBodies.forEach(lb => {
                        const color = lbColors[lbIndex % lbColors.length];
                        lbIndex++;
                        const lbGeometry = getLocalBodyGeometry(lb);
                        const displayGeometry = lbGeometry || lb.geometry;
                        if (displayGeometry) {
                            if (!lb.geometry) lb.geometry = displayGeometry;
                            console.log(`Rendering local body "${lb.name}" with color ${color}`);
                            const layer = L.geoJSON(displayGeometry, {
                                style: {
                                    fillColor: color,
                                    fillOpacity: 0.85,
                                    color: '#ffffff',
                                    weight: 3,
                                    opacity: 1
                                }
                            }).addTo(previewMap._previewLayerGroup || previewMap);
                            allBounds.push(layer.getBounds());
                            console.log(`‚úì Successfully rendered local body "${lb.name}"`);
                        } else {
                            console.warn(`‚úó Local body "${lb.name}" has no geometry`);
                        }
                    });
                });
                if (allBounds.length > 0) {
                    const group = L.featureGroup(allBounds.map(b => L.rectangle(b)));
                    previewMap.fitBounds(group.getBounds(), { padding: [20, 20] });
                    console.log("Map bounds updated to fit all local bodies");
                }
            }
        }

        function renderPreviewWards() {
            const dataGrid = document.getElementById('previewDataGrid');
            dataGrid.innerHTML = '';
            
            console.log("=== Starting Ward Rendering ===");
            console.log("Preview map exists:", !!previewMap);
            
            if (!currentAC || !currentAC.mandals) {
                console.log("No ward data available");
                dataGrid.innerHTML = '<div class="data-item"><span>No data available</span></div>';
                return;
            }

            let totalWards = 0;
            currentAC.mandals.forEach(mandal => {
                ensureMandalLocalBodies(mandal).forEach(lb => {
                    if (lb.wards) totalWards += lb.wards.length;
                });
            });
            const wardColors = getVibrantColors(totalWards);
            let wardIndex = 0;
            allWardsData = [];
            
            currentAC.mandals.forEach(mandal => {
                console.log(`Processing mandal: ${mandal.name}`);
                ensureMandalLocalBodies(mandal).forEach(lb => {
                    console.log(`  Local Body: ${lb.name} | Has wards: ${!!lb.wards} | Ward count: ${lb.wards?.length || 0}`);
                    if (lb.wards) {
                        lb.wards.forEach(ward => {
                            const color = wardColors[wardIndex % wardColors.length];
                            const wardName = ward.ward_name || ward.name || 'Ward ' + (wardIndex + 1);
                            console.log(`    Ward: ${wardName} | Has geometry: ${!!ward.geometry} | Color: ${color}`);
                            wardIndex++;
                            
                            const div = document.createElement('div');
                            div.className = 'data-item';
                            div.innerHTML = `
                                <span class="color-box" style="background-color: ${color}"></span>
                                <strong>${wardName}</strong>
                                <span>${lb.name} | ${mandal.name}</span>
                            `;
                            dataGrid.appendChild(div);
                            allWardsData.push({
                                name: wardName,
                                lb: lb.name,
                                mandal: mandal.name,
                                color
                            });
                        });
                    }
                });
            });

            // Render wards on map with enhanced styling
            if (previewMap && currentAC.mandals.length > 0) {
                let allBounds = [];
                wardIndex = 0;
                currentAC.mandals.forEach(mandal => {
                    ensureMandalLocalBodies(mandal).forEach(lb => {
                        if (lb.wards) {
                            lb.wards.forEach(ward => {
                                const color = wardColors[wardIndex % wardColors.length];
                                wardIndex++;
                                if (ward.geometry) {
                                    const wardName = ward.ward_name || ward.name || 'Ward ' + wardIndex;
                                    console.log(`Rendering ward "${wardName}" with color ${color}`);
                                    const layer = L.geoJSON(ward.geometry, {
                                        style: {
                                            fillColor: color,
                                            fillOpacity: 0.85,
                                            color: '#ffffff',
                                            weight: 3,
                                            opacity: 1
                                        }
                                    }).addTo(previewMap._previewLayerGroup || previewMap);
                                    allBounds.push(layer.getBounds());
                                    console.log(`‚úì Successfully rendered ward "${wardName}"`);
                                } else {
                                    const wardName = ward.ward_name || ward.name || 'Ward ' + wardIndex;
                                    console.warn(`‚úó Ward "${wardName}" has no geometry`);
                                }
                            });
                        }
                    });
                });
                if (allBounds.length > 0) {
                    const group = L.featureGroup(allBounds.map(b => L.rectangle(b)));
                    previewMap.fitBounds(group.getBounds(), { padding: [20, 20] });
                    console.log("Map bounds updated to fit all wards");
                }
            }
        }

        async function downloadPreviewPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('landscape', 'mm', 'a4');
            
            // Page 1: Map Screenshot
            const mapElement = document.getElementById('previewMap');
            const canvas = await html2canvas(mapElement);
            const imgData = canvas.toDataURL('image/png');
            pdf.addImage(imgData, 'PNG', 10, 10, 277, 180);
            
            // Page 2+: Data Table
            const level = document.getElementById('boundaryLevel').value;
            pdf.addPage();
            
            let tableData = [];
            let title = '';

            if (level === 'ac') {
                title = `AC: ${currentAC.name}`;
                tableData = [[currentAC.name, currentAC.mandals.length + ' Mandals']];
                pdf.autoTable({
                    head: [['Assembly Constituency', 'Mandals']],
                    body: tableData,
                    startY: 20,
                    theme: 'grid',
                    headStyles: { fillColor: [41, 128, 185] }
                });
            } else if (level === 'mandal') {
                title = `Mandals in ${currentAC.name}`;
                tableData = currentAC.mandals.map(mandal => [
                    { content: '', styles: { cellWidth: 15 } },
                    mandal.name,
                    ensureMandalLocalBodies(mandal).length + ' Local Bodies'
                ]);
                pdf.autoTable({
                    head: [['Color', 'Mandal', 'Local Bodies']],
                    body: tableData,
                    startY: 20,
                    theme: 'grid',
                    headStyles: { fillColor: [41, 128, 185] },
                    didDrawCell: (data) => {
                        if (data.column.index === 0 && data.row.section === 'body') {
                            const mandal = currentAC.mandals[data.row.index];
                            const fillColor = mandal?.previewColor || '#cccccc';
                            pdf.setFillColor(fillColor);
                            pdf.rect(data.cell.x + 2, data.cell.y + 2, data.cell.width - 4, data.cell.height - 4, 'F');
                        }
                    }
                });
            } else if (level === 'localbody') {
                title = `Local Bodies in ${currentAC.name}`;
                tableData = allLocalBodiesData.map(lb => [
                    { content: '', styles: { cellWidth: 15 } },
                    lb.name,
                    lb.mandal
                ]);
                pdf.autoTable({
                    head: [['Color', 'Local Body', 'Mandal']],
                    body: tableData,
                    startY: 20,
                    theme: 'grid',
                    headStyles: { fillColor: [41, 128, 185] },
                    didDrawCell: (data) => {
                        if (data.column.index === 0 && data.row.section === 'body') {
                            const lb = allLocalBodiesData[data.row.index];
                            pdf.setFillColor(lb.color || '#cccccc');
                            pdf.rect(data.cell.x + 2, data.cell.y + 2, data.cell.width - 4, data.cell.height - 4, 'F');
                        }
                    }
                });
            } else if (level === 'ward') {
                title = `Wards in ${currentAC.name}`;
                tableData = allWardsData.map(ward => [
                    { content: '', styles: { cellWidth: 15 } },
                    ward.name,
                    ward.lb,
                    ward.mandal
                ]);
                pdf.autoTable({
                    head: [['Color', 'Ward', 'Local Body', 'Mandal']],
                    body: tableData,
                    startY: 20,
                    theme: 'grid',
                    headStyles: { fillColor: [41, 128, 185] },
                    didDrawCell: (data) => {
                        if (data.column.index === 0 && data.row.section === 'body') {
                            const ward = allWardsData[data.row.index];
                            pdf.setFillColor(ward.color);
                            pdf.rect(data.cell.x + 2, data.cell.y + 2, data.cell.width - 4, data.cell.height - 4, 'F');
                        }
                    }
                });
            }
            
            pdf.save(`${currentAC.name}_${level}_preview.pdf`);
        }
        
        function openCustomSelector() {
            const acName = currentAC ? currentAC.name : 'AC';
            window.location.href = `localbody_ward_selector.html?from=${encodeURIComponent(acName)}`;
        }
        
        init();
    </script>

    <!-- Preview Modal -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-content">
            <div class="preview-header">
                <h2>Preview & Download</h2>
                <div class="preview-controls">
                    <select id="boundaryLevel" onchange="updatePreviewBoundary()">
                        <option value="ac">Assembly Constituency</option>
                        <option value="mandal" selected>Mandals</option>
                        <option value="localbody">Local Bodies</option>
                        <option value="ward">Wards</option>
                    </select>
                    <button onclick="downloadPreviewPDF()">üì• Download PDF</button>
                </div>
                <button class="preview-close" onclick="closePreview()">√ó</button>
            </div>
            <div class="preview-body">
                <div class="preview-map" id="previewMap"></div>
                <div class="preview-info">
                    <h3>Data Overview</h3>
                    <div class="data-grid" id="previewDataGrid"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
