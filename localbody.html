<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Body View</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: #ffffff;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 15px 20px;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8em;
            margin-bottom: 5px;
            flex-wrap: wrap;
        }
        
        .breadcrumb a {
            color: white;
            text-decoration: none;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        
        .breadcrumb a:hover {
            opacity: 1;
        }
        
        .breadcrumb span {
            opacity: 0.6;
        }
        
        .header h1 {
            font-size: 1.5em;
            font-weight: 600;
        }
        
        .header .subtitle {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 3px;
        }
        
        .map-container {
            height: calc(100vh - 70px);
            position: relative;
            background: #f0f0f0;
        }
        
        #map {
            width: 100%;
            height: 100%;
            background: #f0f0f0;
        }
        
        .leaflet-control-attribution {
            display: none !important;
        }
        
        .leaflet-container {
            background: #f0f0f0 !important;
        }
        
        .info-box {
            position: absolute;
            top: 15px;
            left: 15px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 250px;
        }
        
        .info-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 1em;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 8px;
        }
        
        .info-item {
            margin: 8px 0;
            font-size: 0.9em;
        }
        
        .info-label {
            color: #7f8c8d;
            font-size: 0.85em;
        }
        
        .info-value {
            color: #2c3e50;
            font-weight: 500;
            font-size: 1.1em;
        }
        
        .legend-box {
            position: absolute;
            top: 15px;
            right: 15px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 250px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .legend-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 0.95em;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 8px;
        }
        
        .ward-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin: 8px 0;
            font-size: 0.85em;
            padding: 6px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .ward-item:hover {
            background: #f8f9fa;
        }
        
        .ward-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.2);
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .ward-label {
            color: #2c3e50;
            flex: 1;
            line-height: 1.3;
        }

        /* Preview Modal Styles */
        .nav-actions {
            margin-top: 15px;
            padding: 10px 0;
        }
        
        .action-btn {
            width: 100%;
            padding: 12px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }
        
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        .preview-modal.active {
            display: flex;
        }
        
        .preview-content {
            background: white;
            width: 90%;
            height: 90%;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .preview-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .preview-header h2 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .preview-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: stretch;
            justify-content: center;
        }
        
        .preview-controls select,
        .preview-controls button {
            min-width: 170px;
            height: 44px;
            border: 2px solid white;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            outline: none;
        }
        
        .preview-controls select {
            padding: 0 15px;
        }
        
        .preview-controls select option {
            background: #667eea;
            color: white;
        }
        
        .preview-controls button {
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .preview-controls button:hover {
            background: white;
            color: #667eea;
        }
        
        .preview-close {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .preview-close:hover {
            background: white;
            color: #667eea;
            transform: rotate(90deg);
        }
        
        .preview-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .preview-map {
            flex: 1;
            min-height: 400px;
            background: #ffffff !important;
        }
        
        #previewMap {
            background: #ffffff !important;
        }
        
        #previewMap .leaflet-container {
            background: #ffffff !important;
        }
        
        .preview-info {
            flex: 1;
            background: #ffffff;
            padding: 30px;
            overflow-y: auto;
        }
        
        .preview-info h3 {
            color: #2c3e50;
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            max-width: 100%;
        }
        
        .data-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .data-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .data-item strong {
            display: block;
            color: #495057;
            font-size: 12px;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-item span {
            color: #2c3e50;
            font-size: 16px;
            font-weight: 500;
        }
        
        .color-box {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            display: inline-block;
            margin-right: 10px;
            border: 2px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="breadcrumb">
            <a href="kerala_map.html">Kerala</a>
            <span>/</span>
            <a href="#" id="districtLink">District</a>
            <span>/</span>
            <a href="#" id="acLink">AC</a>
            <span>/</span>
            <a href="#" id="mandalLink">Mandal</a>
            <span>/</span>
            <span id="lbBreadcrumb">Local Body</span>
        </div>
        <h1 id="lbTitle">Loading...</h1>
        <div class="subtitle" id="lbSubtitle"></div>
    </div>
    
    <div class="map-container">
        <div id="map"></div>
        <div class="info-box">
            <div class="info-title">Local Body Info</div>
            <div class="info-item">
                <div class="info-label">Type</div>
                <div class="info-value" id="lbType">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">Code</div>
                <div class="info-value" id="lbCode">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">Total Wards</div>
                <div class="info-value" id="totalWards">-</div>
            </div>
        </div>
        <div class="legend-box">
            <div class="legend-title">Wards</div>
            <div id="wardList"></div>
        </div>
        <div class="nav-actions">
            <button class="action-btn" onclick="showPreview()">
                üëÅÔ∏è Preview & Download
            </button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, currentMandal, currentLB, wardLayers = {};
        let corpMandalsCache = null;
        let kovalamCorpCache = null;
        
        const urlParams = new URLSearchParams(window.location.search);
        const districtId = urlParams.get('district');
        const acId = urlParams.get('ac');
        const mandalId = urlParams.get('mandal');
        const lbId = urlParams.get('lb');
        
        if (!districtId || !acId || !mandalId || !lbId) {
            alert('Invalid parameters!');
            window.location.href = 'kerala_map.html';
        }
        
        // Vibrant color palette for distinct polygon colors
        const vibrantColors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
            '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B195', '#F67280',
            '#C06C84', '#6C5B7B', '#355C7D', '#99B898', '#FECEAB',
            '#FF847C', '#E84A5F', '#2A363B', '#A8E6CF', '#FFD3B6',
            '#FFAAA5', '#FF8B94', '#FEC3A6', '#EFE9AE', '#CDEAC0',
            '#8E44AD', '#3498DB', '#1ABC9C', '#F39C12', '#E74C3C',
            '#9B59B6', '#2ECC71', '#E67E22', '#95A5A6', '#34495E'
        ];

        function getVibrantColors(count) {
            const colors = [];
            for (let i = 0; i < count; i++) {
                colors.push(vibrantColors[i % vibrantColors.length]);
            }
            return colors;
        }

        let wardColors = []; // Will be set after loading ward data
        
        map = L.map('map', {
            zoomControl: true,
            attributionControl: false,
            preferCanvas: true
        }).setView([10.8505, 76.2711], 11);
        
        function cleanId(name) {
            return name.toLowerCase().replace(/[^a-z0-9]/g, '');
        }
        
        async function loadCorporationMandalsData() {
            if (corpMandalsCache) return corpMandalsCache;
            try {
                const response = await fetch('data/corporation_mandals.json');
                if (!response.ok) {
                    corpMandalsCache = { features: [] };
                    return corpMandalsCache;
                }
                corpMandalsCache = await response.json();
            } catch (error) {
                console.warn('Unable to load corporation mandals data', error);
                corpMandalsCache = { features: [] };
            }
            return corpMandalsCache;
        }

        async function getCorporationMandalFeature(districtId, acId, mandalId) {
            const data = await loadCorporationMandalsData();
            const targetDistrict = cleanId(districtId || '');
            const targetAc = cleanId(acId || '');
            const targetMandal = cleanId(mandalId || '');
            return (data.features || []).find(feature => {
                const props = feature.properties || {};
                return cleanId(props.district_id || '') === targetDistrict &&
                       cleanId(props.ac_id || '') === targetAc &&
                       cleanId(props.mandal_id || props.mandal_name || '') === targetMandal;
            });
        }

        function buildSyntheticMandal(feature) {
            const props = feature.properties || {};
            const wardFeatures = (props.ward_features || []).map(ward => ({
                ward_number: ward?.properties?.ward_number || ward?.ward_number,
                ward_name: ward?.properties?.ward_name || ward?.ward_name,
                geometry: ward.geometry
            }));
            const lbId = `corp_${props.mandal_id || cleanId(props.mandal_name || '')}`;
            const syntheticLB = {
                id: lbId,
                name: props.mandal_name || props.corporation_name,
                type: 'Corporation Mandal',
                code: props.corporation_id || '',
                wards: wardFeatures,
                geometry: {
                    type: 'FeatureCollection',
                    features: (props.ward_features || [])
                },
                isCorporationLocalBody: true
            };
            return {
                name: props.mandal_name || props.corporation_name,
                id: props.mandal_id,
                isCorporationMandal: true,
                geometry: feature,
                local_bodies: [syntheticLB]
            };
        }

        async function init() {
            try {
                // Load consolidated 14-district data
                const response = await fetch(`data/14_districts/${districtId}.json`);
                if (!response.ok) {
                    alert('District data not found!');
                    return;
                }
                
                const districtData = await response.json();
                
                // Find AC
                const ac = districtData.acs.find(a => cleanId(a.name) === acId);
                if (!ac) {
                    alert('AC not found!');
                    return;
                }
                
                await ensureKovalamCorporationSlice(ac);
                
                // Find Mandal
                let mandal = ac.mandals.find(m => cleanId(m.name) === mandalId);
                currentMandal = mandal;
                if (!currentMandal) {
                    const corpFeature = await getCorporationMandalFeature(districtId, acId, mandalId);
                    if (corpFeature) {
                        currentMandal = buildSyntheticMandal(corpFeature);
                    }
                }
                
                if (!currentMandal) {
                    alert('Mandal not found!');
                    return;
                }
                
                // Find Local Body
                const normalizedLbId = lbId || (currentMandal.isCorporationMandal ? currentMandal.local_bodies[0]?.id : null);
                currentLB = currentMandal.local_bodies.find(lb => {
                    if (lb.id && normalizedLbId) return lb.id === normalizedLbId;
                    if (normalizedLbId) return cleanId(lb.name) === normalizedLbId;
                    return false;
                });
                if (!currentLB && currentMandal.isCorporationMandal) {
                    currentLB = currentMandal.local_bodies[0];
                }

                if (!currentLB) {
                    alert('Local Body not found!');
                    console.log('Looking for:', lbId);
                    console.log('Available:', currentMandal.local_bodies.map(lb => lb.id || cleanId(lb.name)));
                    return;
                }
                
                // Update header
                const lbType = currentLB.type === 'M' ? 'Municipality' : (currentLB.type === 'C' ? 'Corporation' : 'Grama Panchayat');
                document.getElementById('lbTitle').textContent = currentLB.name;
                document.getElementById('lbSubtitle').textContent = lbType;
                document.getElementById('lbBreadcrumb').textContent = currentLB.name;
                document.getElementById('districtLink').href = `district.html?district=${districtId}`;
                document.getElementById('acLink').href = `ac.html?district=${districtId}&ac=${acId}`;
                document.getElementById('mandalLink').href = `mandal.html?district=${districtId}&ac=${acId}&mandal=${mandalId}`;
                document.title = `${currentLB.name} - Local Body View`;
                
                // Update info
                document.getElementById('lbType').textContent = lbType;
                document.getElementById('lbCode').textContent = currentLB.code || 'N/A';
                document.getElementById('totalWards').textContent = currentLB.wards.length;
                
                // Load ward boundaries
                await loadWardBoundaries();
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading local body data.');
            }
        }

        async function loadKovalamCorpData() {
            if (kovalamCorpCache !== null) {
                return kovalamCorpCache;
            }
            try {
                const response = await fetch('data/thiruvananthapuram_south/kovalam/kovalam/tvm_corporation_kovalam.geojson');
                if (!response.ok) {
                    kovalamCorpCache = null;
                    return null;
                }
                kovalamCorpCache = await response.json();
            } catch (error) {
                console.warn('Unable to load TVM Corporation (Kovalam) data', error);
                kovalamCorpCache = null;
            }
            return kovalamCorpCache;
        }

        async function ensureKovalamCorporationSlice(acReference) {
            if (!(districtId === 'thiruvananthapuram_south' && acId === 'kovalam')) {
                return;
            }
            if (!acReference) return;
            
            const mandal = acReference.mandals.find(m => cleanId(m.name) === 'kovalam');
            if (!mandal) return;
            
            const exists = mandal.local_bodies.some(lb => cleanId(lb.name) === 'tvm_corporation_kovalam');
            if (exists) return;
            
            const geojson = await loadKovalamCorpData();
            if (!geojson) return;
            
            const wards = (geojson.features || []).map((feature, index) => ({
                ward_number: feature?.properties?.ward_number || feature?.properties?.Ward_No || `${index + 1}`,
                ward_name: feature?.properties?.ward_name || feature?.properties?.Ward_Name || `Ward ${index + 1}`,
                geometry: feature.geometry
            }));
            
            const lbGeometry = {
                type: 'FeatureCollection',
                features: (geojson.features || []).map(feature => ({
                    type: 'Feature',
                    properties: {
                        ward_number: feature?.properties?.ward_number || feature?.properties?.Ward_No || '',
                        ward_name: feature?.properties?.ward_name || feature?.properties?.Ward_Name || ''
                    },
                    geometry: feature.geometry
                }))
            };
            
            mandal.local_bodies.push({
                name: 'TVM Corporation (Kovalam)',
                id: 'tvm_corporation_kovalam',
                code: 'C01001',
                type: 'C',
                wards,
                geometry: lbGeometry
            });
        }
        
        async function loadWardBoundaries() {
            try {
                const wardListDiv = document.getElementById('wardList');
                wardListDiv.innerHTML = '';
                
                let allLayers = [];
                
                // Check if ward geometries are embedded in the local body data
                if (!currentLB.wards || currentLB.wards.length === 0) {
                    alert('No ward data available for this local body.');
                    return;
                }
                
                // Set ward colors based on actual ward count
                wardColors = getVibrantColors(currentLB.wards.length);
                
                currentLB.wards.forEach((ward, index) => {
                    if (!ward.geometry) return;
                    
                    const wardNo = ward.ward_number || (index + 1);
                    const wardName = ward.ward_name || `Ward ${wardNo}`;
                    const color = wardColors[index % wardColors.length];
                    
                    const layer = L.geoJSON(ward.geometry, {
                        style: {
                            fillColor: color,
                            fillOpacity: 0.6,
                            color: '#2c3e50',
                            weight: 2
                        },
                        onEachFeature: function(feature, layer) {
                            layer.on({
                                mouseover: function(e) {
                                    e.target.setStyle({
                                        fillOpacity: 0.9,
                                        weight: 3
                                    });
                                },
                                mouseout: function(e) {
                                    e.target.setStyle({
                                        fillOpacity: 0.6,
                                        weight: 2
                                    });
                                },
                                click: function() {
                                    map.fitBounds(layer.getBounds(), { padding: [50, 50] });
                                }
                            });
                            
                            layer.bindPopup(`
                                <div style="text-align: center; padding:10px;">
                                    <div style="font-size:1.1em; font-weight:600; color:#2c3e50; margin-bottom:5px;">${currentLB.name}</div>
                                    <div style="font-weight:600; color:#3498db; margin:5px 0;">Ward ${wardNo}</div>
                                    <div style="color:#555;">${wardName}</div>
                                </div>
                            `);
                        }
                    }).addTo(map);
                    
                    allLayers.push(layer);
                    wardLayers[wardNo] = layer;
                    
                    // Add ward label on map with ward name
                    const center = layer.getBounds().getCenter();
                    L.marker(center, {
                        icon: L.divIcon({
                            className: 'ward-number-label',
                            html: `<div style="font-size:10px; font-weight:700; color:#2c3e50; text-align:center; background:rgba(255,255,255,0.8); border-radius:50%; width:20px; height:20px; line-height:20px; border:2px solid ${color}; pointer-events:none;">${wardNo}</div>`,
                            iconSize: [20, 20]
                        }),
                        interactive: false
                    }).addTo(map);
                    
                    // Add to legend with ward name
                    const wardItem = document.createElement('div');
                    wardItem.className = 'ward-item';
                    wardItem.innerHTML = `
                        <div class="ward-color" style="background: ${color}"></div>
                        <div class="ward-label">
                            <div style="font-weight:600;">Ward ${wardNo}</div>
                            <div style="font-size:0.85em; color:#555;">${wardName}</div>
                        </div>
                    `;
                    wardItem.addEventListener('click', function() {
                        map.fitBounds(layer.getBounds(), { padding: [50, 50] });
                        layer.openPopup();
                    });
                    wardListDiv.appendChild(wardItem);
                });
                
                // Fit map to all wards
                if (allLayers.length > 0) {
                    const group = L.featureGroup(allLayers);
                    map.fitBounds(group.getBounds(), { padding: [50, 50] });
                }
                
            } catch (error) {
                console.error('Error loading ward boundaries:', error);
                alert('Error loading ward data: ' + error.message);
            }
        }

        // Preview & Download functionality
        let previewMap;

        function showPreview() {
            const modal = document.getElementById('previewModal');
            modal.classList.add('active');
            
            setTimeout(() => {
                if (previewMap) {
                    previewMap.remove();
                    previewMap = null;
                }
                
                const mapContainer = document.getElementById('previewMap');
                previewMap = L.map(mapContainer, {
                    zoomControl: true,
                    attributionControl: false,
                    preferCanvas: true
                }).setView([10.8505, 76.2711], 10);
                previewMap._previewLayerGroup = L.layerGroup().addTo(previewMap);
                
                // Wait for map container to be fully sized
                setTimeout(() => {
                    previewMap.invalidateSize();
                    updatePreviewBoundary();
                }, 100);
            }, 150);
        }

        function closePreview() {
            document.getElementById('previewModal').classList.remove('active');
            if (previewMap) {
                previewMap.remove();
                previewMap = null;
            }
        }

        function updatePreviewBoundary() {
            const level = document.getElementById('boundaryLevel').value;
            
            if (previewMap && previewMap._previewLayerGroup) {
                previewMap._previewLayerGroup.clearLayers();
            }

            if (level === 'localbody') {
                renderPreviewLocalBody();
            } else if (level === 'ward') {
                renderPreviewWards();
            }
        }

        function renderPreviewLocalBody() {
            const dataGrid = document.getElementById('previewDataGrid');
            dataGrid.innerHTML = `
                <div class="data-item">
                    <strong>Local Body</strong>
                    <span>${currentLocalBody.name}</span>
                </div>
                <div class="data-item">
                    <strong>Total Wards</strong>
                    <span>${currentLocalBody.wards ? currentLocalBody.wards.length : 0}</span>
                </div>
            `;

            if (previewMap) {
                const layerTarget = previewMap._previewLayerGroup || previewMap;
                const color = '#7C3AED';
                const bounds = [];

                const drawGeometry = (geometry) => {
                    const layer = L.geoJSON(geometry, {
                        style: {
                            fillColor: color,
                            fillOpacity: 0.85,
                            color: '#ffffff',
                            weight: 3,
                            opacity: 1
                        }
                    }).addTo(layerTarget);
                    bounds.push(layer.getBounds());
                };

                if (currentLocalBody.geometry) {
                    drawGeometry(currentLocalBody.geometry);
                } else if (currentLocalBody.wards) {
                    currentLocalBody.wards.forEach(ward => {
                        if (ward.geometry) {
                            drawGeometry(ward.geometry);
                        }
                    });
                }

                if (bounds.length > 0) {
                    const group = L.featureGroup(bounds.map(b => L.rectangle(b)));
                    previewMap.fitBounds(group.getBounds(), { padding: [20, 20] });
                }
            }
        }

        function renderPreviewWards() {
            const dataGrid = document.getElementById('previewDataGrid');
            dataGrid.innerHTML = '';
            
            if (!currentLocalBody || !currentLocalBody.wards) {
                dataGrid.innerHTML = '<div class="data-item"><span>No ward data available</span></div>';
                return;
            }

            const wardColors = ['#9C27B0', '#FF9800', '#E91E63', '#FF5722', '#00BCD4', '#8BC34A', '#2196F3'];
            
            currentLocalBody.wards.forEach((ward, index) => {
                const color = wardColors[index % wardColors.length];
                
                const div = document.createElement('div');
                div.className = 'data-item';
                div.innerHTML = `
                    <span class="color-box" style="background-color: ${color}"></span>
                    <strong>${ward.ward_name || ward.name || 'Ward ' + (index + 1)}</strong>
                `;
                dataGrid.appendChild(div);
            });

            // Render wards on map with vibrant colors
            if (previewMap && currentLocalBody.wards.length > 0) {
                let allBounds = [];
                currentLocalBody.wards.forEach((ward, index) => {
                    const color = wardColors[index % wardColors.length];
                    if (ward.geometry) {
                        const layer = L.geoJSON(ward.geometry, {
                            style: {
                                fillColor: color,
                                fillOpacity: 0.85,
                                color: '#ffffff',
                                weight: 3,
                                opacity: 1
                            }
                        }).addTo(previewMap._previewLayerGroup || previewMap);
                        allBounds.push(layer.getBounds());
                    }
                });
                if (allBounds.length > 0) {
                    const group = L.featureGroup(allBounds.map(b => L.rectangle(b)));
                    previewMap.fitBounds(group.getBounds(), { padding: [20, 20] });
                }
            }
        }

        async function downloadPreviewPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('landscape', 'mm', 'a4');
                
                // Title
                let title = `${currentLocalBody.name} - WARD Map`;
                
                // PAGE 1: Map Screenshot
                pdf.setFontSize(18);
                pdf.setTextColor(40, 40, 40);
                pdf.text(title, pdf.internal.pageSize.width / 2, 15, { align: 'center' });
                
                const mapElement = document.getElementById('previewMap');
                const canvas = await html2canvas(mapElement, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    logging: false
                });
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 277;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                pdf.addImage(imgData, 'PNG', 10, 25, imgWidth, Math.min(imgHeight, 170));
                
                // PAGE 2: Data Table with Colors
                pdf.addPage();
                pdf.setFontSize(18);
                pdf.text(`${title} - Ward Details`, 10, 15);
                
                let tableData = [];
                let tableHeaders = [['Color', 'Ward No', 'Ward Name', 'Local Body']];
                const wardColors = ['#9C27B0', '#FF9800', '#E91E63', '#FF5722', '#00BCD4', '#8BC34A', '#2196F3'];
                
                if (currentLocalBody.wards) {
                    currentLocalBody.wards.forEach((ward, index) => {
                        const color = wardColors[index % wardColors.length];
                        const row = [
                            '',
                            (ward.ward_number || index + 1).toString(),
                            ward.ward_name || ward.name || 'Ward ' + (index + 1),
                            currentLocalBody.name
                        ];
                        row._color = color;
                        tableData.push(row);
                    });
                }
                
                pdf.autoTable({
                    head: tableHeaders,
                    body: tableData.map(row => {
                        const cleanRow = [...row];
                        delete cleanRow._color;
                        return cleanRow;
                    }),
                    startY: 25,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [41, 100, 235],
                        textColor: 255,
                        fontStyle: 'bold',
                        halign: 'left'
                    },
                    columnStyles: {
                        0: { cellWidth: 15, halign: 'center' }
                    },
                    didDrawCell: (data) => {
                        if (data.column.index === 0 && data.row.section === 'body') {
                            const rowData = tableData[data.row.index];
                            if (rowData && rowData._color) {
                                const color = rowData._color;
                                const r = parseInt(color.slice(1, 3), 16);
                                const g = parseInt(color.slice(3, 5), 16);
                                const b = parseInt(color.slice(5, 7), 16);
                                
                                pdf.setFillColor(r, g, b);
                                pdf.rect(
                                    data.cell.x + 2,
                                    data.cell.y + 2,
                                    data.cell.width - 4,
                                    data.cell.height - 4,
                                    'F'
                                );
                            }
                        }
                    },
                    margin: { top: 25, left: 10, right: 10 }
                });
                
                // Add page numbers
                const pageCount = pdf.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(10);
                    pdf.setTextColor(150);
                    pdf.text(
                        `Page ${i} of ${pageCount}`,
                        pdf.internal.pageSize.width - 30,
                        pdf.internal.pageSize.height - 10
                    );
                }
                
                const filename = `${currentLocalBody.name.replace(/[^a-z0-9]/gi, '_')}_ward_map.pdf`;
                pdf.save(filename);
                
                alert('‚úÖ PDF generated successfully!');
                
            } catch (error) {
                console.error('PDF generation error:', error);
                alert('‚ùå Error generating PDF: ' + error.message);
            }
        }
        
        function openCustomSelector() {
            const localBodyName = currentLocalBody ? currentLocalBody.name : 'Local Body';
            window.location.href = `localbody_ward_selector.html?from=${encodeURIComponent(localBodyName)}`;
        }
        
        init();
    </script>

    <!-- Preview Modal -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-content">
            <div class="preview-header">
                <h2>Preview & Download</h2>
                <div class="preview-controls">
                    <select id="boundaryLevel" onchange="updatePreviewBoundary()">
                        <option value="localbody">Local Body</option>
                        <option value="ward" selected>Wards</option>
                    </select>
                    <button onclick="downloadPreviewPDF()">üì• Download PDF</button>
                    <button onclick="openCustomSelector()">üìã Select Specific Wards</button>
                </div>
                <button class="preview-close" onclick="closePreview()">√ó</button>
            </div>
            <div class="preview-body">
                <div class="preview-map" id="previewMap"></div>
                <div class="preview-info">
                    <h3>Data Overview</h3>
                    <div class="data-grid" id="previewDataGrid"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
